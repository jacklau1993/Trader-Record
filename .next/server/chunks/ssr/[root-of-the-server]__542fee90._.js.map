{"version":3,"sources":["../../../../app/actions/trade-actions.ts","../../../../.next-internal/server/app/trades/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["\"use server\";\n\nimport { auth } from \"@/lib/auth\";\nimport { headers } from \"next/headers\";\nimport { getDb } from \"@/lib/db\";\nimport { trades, tradeTags } from \"@/db/schema\";\nimport { eq, desc, and, inArray } from \"drizzle-orm\";\nimport { revalidatePath } from \"next/cache\";\n\n// Helper to get authenticated user\nasync function getUser() {\n    const session = await auth.api.getSession({\n        headers: await headers()\n    });\n    if (!session?.user) {\n        throw new Error(\"Unauthorized\");\n    }\n    return session.user;\n}\n\nexport async function getTrades() {\n    const user = await getUser();\n    const db = getDb();\n\n    // 1. Fetch trades\n    const userTrades = await db.select()\n        .from(trades)\n        .where(eq(trades.userId, user.id))\n        .orderBy(desc(trades.date));\n\n    // 2. Fetch tags for these trades\n    // We can do this efficiently by fetching all trade_tags for these trade IDs\n    const tradeIds = userTrades.map(t => t.id);\n    let tagsMap: Record<string, string[]> = {};\n\n    if (tradeIds.length > 0) {\n        const relatedTags = await db.select()\n            .from(tradeTags)\n            .where(inArray(tradeTags.tradeId, tradeIds));\n\n        relatedTags.forEach(rt => {\n            if (!tagsMap[rt.tradeId]) tagsMap[rt.tradeId] = [];\n            tagsMap[rt.tradeId].push(rt.tagId);\n        });\n    }\n\n    // 3. Merge\n    return userTrades.map(t => ({\n        ...t,\n        tags: tagsMap[t.id] || []\n    }));\n}\n\nexport async function getTrade(id: string) {\n    const user = await getUser();\n    const db = getDb();\n\n    const trade = await db.select().from(trades).where(and(eq(trades.id, id), eq(trades.userId, user.id))).get();\n\n    if (!trade) return null;\n\n    const tags = await db.select().from(tradeTags).where(eq(tradeTags.tradeId, id));\n\n    return {\n        ...trade,\n        tags: tags.map(t => t.tagId)\n    };\n}\n\n// Define Input Type\ntype CreateTradeInput = Omit<typeof trades.$inferInsert, \"userId\"> & { tags?: string[] };\n\nexport async function createTrade(data: CreateTradeInput) {\n    const user = await getUser();\n    const db = getDb();\n\n    const { tags: tagIds, ...tradeData } = data;\n\n    // Force userId to match session\n    const newTrade = {\n        ...tradeData,\n        userId: user.id,\n        createdAt: new Date(),\n        updatedAt: new Date()\n    };\n\n    await db.insert(trades).values(newTrade);\n\n    if (tagIds && tagIds.length > 0) {\n        for (const tagId of tagIds) {\n            await db.insert(tradeTags).values({\n                tradeId: newTrade.id,\n                tagId: tagId\n            });\n        }\n    }\n\n    revalidatePath(\"/trades\");\n    revalidatePath(\"/\");\n    revalidatePath(\"/reports\");\n    return { success: true };\n}\n\nexport async function updateTrade(id: string, data: Partial<CreateTradeInput>) {\n    const user = await getUser();\n    const db = getDb();\n\n    const { tags: tagIds, ...tradeData } = data;\n\n    if (Object.keys(tradeData).length > 0) {\n        await db.update(trades)\n            .set({ ...tradeData, updatedAt: new Date() })\n            .where(and(eq(trades.id, id), eq(trades.userId, user.id)));\n    }\n\n    if (tagIds !== undefined) {\n        // Replace tags\n        // 1. Delete existing for this trade\n        await db.delete(tradeTags).where(eq(tradeTags.tradeId, id));\n\n        // 2. Insert new\n        if (tagIds.length > 0) {\n            for (const tagId of tagIds) {\n                await db.insert(tradeTags).values({\n                    tradeId: id,\n                    tagId: tagId\n                });\n            }\n        }\n    }\n\n    revalidatePath(\"/trades\");\n    revalidatePath(`/trades/${id}`);\n    revalidatePath(\"/\");\n    revalidatePath(\"/reports\");\n    return { success: true };\n}\n\nexport async function deleteTrade(id: string) {\n    const user = await getUser();\n    const db = getDb();\n\n    await db.delete(trades)\n        .where(and(eq(trades.id, id), eq(trades.userId, user.id)));\n    // Cascade should handle tradeTags deletion or we can do manual if needed.\n    // Schema has onDelete: cascade, so it should be fine.\n\n    revalidatePath(\"/trades\");\n    revalidatePath(\"/\");\n    revalidatePath(\"/reports\");\n    return { success: true };\n}\n","export {getTrades as '003bdb41977fafc385b089ea1b1a363d738935fdfc'} from 'ACTIONS_MODULE0'\nexport {getTrade as '404d76a0830acf0ac4288e23290c039cbd3c7de1ce'} from 'ACTIONS_MODULE0'\nexport {createTrade as '40a6cc6f1f2178696141d579a69bfb77252b4d97f8'} from 'ACTIONS_MODULE0'\nexport {deleteTrade as '40ff44ff1593cccb6762fa1dfdda55b4f154bce892'} from 'ACTIONS_MODULE0'\nexport {updateTrade as '60ebe67b8ff8ece876c43cb6478d274e72270a4de9'} from 'ACTIONS_MODULE0'\n"],"names":[],"mappings":"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"}